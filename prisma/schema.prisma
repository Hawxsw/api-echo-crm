generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE
}

enum PermissionResource {
  USERS
  ROLES
  KANBAN_BOARDS
  KANBAN_CARDS
  CHAT
  WHATSAPP
  REPORTS
  SALES_PIPELINE
  SALES_OPPORTUNITIES
  ALL
}

enum KanbanCardPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WhatsAppMessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum SalesOpportunityPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SalesActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
}

enum SalesActivityStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  MESSAGE
  TASK_ASSIGNED
  TASK_COMMENT
  TASK_DUE_SOON
  WHATSAPP_MESSAGE
  SALES_ASSIGNED
  SALES_COMMENT
  MENTION
  SYSTEM
}

model Role {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  description String?
  isSystem    Boolean   @default(false)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  users       User[]
  permissions Permission[]
  
  @@map("roles")
}

model Permission {
  id          String              @id @default(uuid()) @db.Uuid
  roleId      String              @db.Uuid
  action      PermissionAction
  resource    PermissionResource
  conditions  Json?               @db.JsonB
  createdAt   DateTime            @default(now()) @db.Timestamptz(3)
  
  role        Role                @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, action, resource])
  @@index([roleId])
  @@map("permissions")
}

model Department {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  parentId    String?   @db.Uuid
  level       Int       @default(0)
  position    Int       @default(0)
  isActive    Boolean   @default(true)
  color       String?
  icon        String?
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)

  parent      Department? @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Department[] @relation("DepartmentHierarchy")
  users       User[]
  managers    User[]      @relation("DepartmentManagers")

  @@index([parentId])
  @@index([level])
  @@map("departments")
}

model User {
  id            String      @id @default(uuid()) @db.Uuid
  email         String      @unique
  password      String
  firstName     String
  lastName      String
  avatar        String?
  phone         String?
  roleId        String?     @db.Uuid
  status        UserStatus  @default(ACTIVE)
  departmentId  String?     @db.Uuid
  managerId     String?     @db.Uuid
  position      String?
  isManager     Boolean     @default(false)
  isDepartmentHead Boolean  @default(false)
  managedDepartmentId String? @db.Uuid
  sortOrder     Int?
  createdAt     DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime    @updatedAt @db.Timestamptz(3)
  lastLoginAt   DateTime?   @db.Timestamptz(3)

  role          Role?       @relation(fields: [roleId], references: [id], onDelete: SetNull)
  department    Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  manager       User?       @relation("UserHierarchy", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates  User[]      @relation("UserHierarchy")
  managedDepartment Department? @relation("DepartmentManagers", fields: [managedDepartmentId], references: [id], onDelete: SetNull)
  
  sentMessages       Message[]        @relation("SentMessages")
  chatParticipants   ChatParticipant[]
  assignedCards      KanbanCard[]     @relation("AssignedCards")
  createdCards       KanbanCard[]     @relation("CreatedCards")
  cardComments       CardComment[]
  cardActivities     CardActivity[]
  whatsappConversations WhatsAppConversation[]
  createdOpportunities SalesOpportunity[] @relation("CreatedOpportunities")
  assignedOpportunities SalesOpportunity[] @relation("AssignedOpportunities")
  salesComments      SalesComment[] @relation("SalesComments")
  salesActivities    SalesActivity[] @relation("SalesActivities")
  notifications      Notification[]
  
  @@index([roleId])
  @@index([departmentId])
  @@index([managerId])
  @@index([managedDepartmentId])
  @@index([email])
  @@map("users")
}

model Chat {
  id          String    @id @default(uuid()) @db.Uuid
  name        String?
  isGroup     Boolean   @default(false)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  participants ChatParticipant[]
  messages     Message[]
  
  @@map("chats")
}

model ChatParticipant {
  id          String    @id @default(uuid()) @db.Uuid
  chatId      String    @db.Uuid
  userId      String    @db.Uuid
  joinedAt    DateTime  @default(now()) @db.Timestamptz(3)
  lastReadAt  DateTime? @db.Timestamptz(3)
  
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatId, userId])
  @@index([userId])
  @@index([chatId])
  @@map("chat_participants")
}

model Message {
  id          String    @id @default(uuid()) @db.Uuid
  content     String    @db.Text
  chatId      String    @db.Uuid
  senderId    String    @db.Uuid
  isEdited    Boolean   @default(false)
  isDeleted   Boolean   @default(false)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model WhatsAppConversation {
  id            String    @id @default(uuid()) @db.Uuid
  clientName    String
  clientPhone   String    @unique
  assignedToId  String?   @db.Uuid
  isActive      Boolean   @default(true)
  lastMessageAt DateTime  @default(now()) @db.Timestamptz(3)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)
  
  assignedTo    User?     @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  messages      WhatsAppMessage[]
  
  @@index([assignedToId])
  @@index([clientPhone])
  @@index([lastMessageAt])
  @@map("whatsapp_conversations")
}

model WhatsAppMessage {
  id              String                  @id @default(uuid()) @db.Uuid
  conversationId  String                  @db.Uuid
  content         String                  @db.Text
  isFromClient    Boolean                 @default(true)
  status          WhatsAppMessageStatus   @default(SENT)
  createdAt       DateTime                @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime                @updatedAt @db.Timestamptz(3)
  
  conversation    WhatsAppConversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([createdAt])
  @@map("whatsapp_messages")
}

model KanbanBoard {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  columns     KanbanColumn[]
  
  @@map("kanban_boards")
}

model KanbanColumn {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  position    Int
  boardId     String    @db.Uuid
  color       String?
  limit       Int?
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  board       KanbanBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards       KanbanCard[]
  
  @@unique([boardId, position])
  @@index([boardId])
  @@map("kanban_columns")
}

model KanbanCard {
  id            String              @id @default(uuid()) @db.Uuid
  title         String
  description   String?             @db.Text
  columnId      String              @db.Uuid
  position      Int
  priority      KanbanCardPriority  @default(MEDIUM)
  dueDate       DateTime?           @db.Timestamptz(3)
  createdById   String              @db.Uuid
  assignedToId  String?             @db.Uuid
  tags          String[]            @default([])
  createdAt     DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime            @updatedAt @db.Timestamptz(3)
  
  column        KanbanColumn        @relation(fields: [columnId], references: [id], onDelete: Cascade)
  createdBy     User                @relation("CreatedCards", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo    User?               @relation("AssignedCards", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  comments      CardComment[]
  attachments   CardAttachment[]
  activities    CardActivity[]
  
  @@unique([columnId, position])
  @@index([columnId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([dueDate])
  @@map("kanban_cards")
}

model CardComment {
  id          String    @id @default(uuid()) @db.Uuid
  content     String    @db.Text
  cardId      String    @db.Uuid
  userId      String    @db.Uuid
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  card        KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([cardId])
  @@index([userId])
  @@map("card_comments")
}

model CardAttachment {
  id          String    @id @default(uuid()) @db.Uuid
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  cardId      String    @db.Uuid
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  
  card        KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  @@index([cardId])
  @@map("card_attachments")
}

model CardActivity {
  id          String    @id @default(uuid()) @db.Uuid
  action      String
  description String    @db.Text
  cardId      String    @db.Uuid
  userId      String    @db.Uuid
  metadata    Json?     @db.JsonB
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  
  card        KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([cardId])
  @@index([userId])
  @@index([createdAt])
  @@map("card_activities")
}

model SalesPipeline {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @db.Text
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  stages      SalesStage[]
  
  @@map("sales_pipelines")
}

model SalesStage {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @db.Text
  position    Int
  color       String    @default("#3B82F6")
  pipelineId  String    @db.Uuid
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  pipeline    SalesPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  opportunities SalesOpportunity[]
  
  @@unique([pipelineId, position])
  @@index([pipelineId])
  @@map("sales_stages")
}

model SalesOpportunity {
  id            String                  @id @default(uuid()) @db.Uuid
  title         String
  description   String?                 @db.Text
  company       String
  contact       String
  email         String?
  phone         String?
  value         Decimal                 @default(0) @db.Decimal(15, 2)
  stageId       String                  @db.Uuid
  priority      SalesOpportunityPriority @default(MEDIUM)
  createdById   String                  @db.Uuid
  assignedToId  String?                 @db.Uuid
  tags          String[]                @default([])
  createdAt     DateTime                @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime                @updatedAt @db.Timestamptz(3)
  
  stage         SalesStage              @relation(fields: [stageId], references: [id], onDelete: Cascade)
  createdBy     User                    @relation("CreatedOpportunities", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo    User?                   @relation("AssignedOpportunities", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  comments      SalesComment[]
  activities    SalesActivity[]
  
  @@index([stageId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([company])
  @@map("sales_opportunities")
}

model SalesComment {
  id              String    @id @default(uuid()) @db.Uuid
  content         String    @db.Text
  isPinned        Boolean   @default(false)
  opportunityId   String    @db.Uuid
  userId          String    @db.Uuid
  createdAt       DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(3)
  
  opportunity     SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user            User             @relation("SalesComments", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([opportunityId])
  @@index([userId])
  @@map("sales_comments")
}

model SalesActivity {
  id              String              @id @default(uuid()) @db.Uuid
  type            SalesActivityType
  title           String
  description     String?             @db.Text
  scheduledDate   DateTime            @db.Timestamptz(3)
  scheduledTime   String
  completedDate   DateTime?           @db.Timestamptz(3)
  completedTime   String?
  status          SalesActivityStatus @default(SCHEDULED)
  opportunityId   String              @db.Uuid
  assignedToId    String              @db.Uuid
  createdAt       DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime            @updatedAt @db.Timestamptz(3)
  
  opportunity     SalesOpportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  assignedTo      User                @relation("SalesActivities", fields: [assignedToId], references: [id], onDelete: Cascade)
  
  @@index([opportunityId])
  @@index([assignedToId])
  @@index([scheduledDate])
  @@map("sales_activities")
}

model Notification {
  id          String            @id @default(uuid()) @db.Uuid
  type        NotificationType
  title       String
  message     String            @db.Text
  userId      String            @db.Uuid
  isRead      Boolean           @default(false)
  metadata    Json?             @db.JsonB
  actionUrl   String?
  createdAt   DateTime          @default(now()) @db.Timestamptz(3)
  readAt      DateTime?         @db.Timestamptz(3)
  
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

